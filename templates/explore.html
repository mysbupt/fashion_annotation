<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/static/favicon.ico">
    <title>MMKG in Fashion</title>
    <link href="../static/css/signin.css" rel="stylesheet">
    <link href="../static/css/style.css" rel="stylesheet">
    <link href="../static/css/ivew.css" rel="stylesheet">
    <link href="../static/css/explore.css" rel="stylesheet">
  </head>

  <body>
    <div id="app">
      <i-menu mode="horizontal" :theme="'dark'" active-name="1" class='mmkg-header'>
        <i-menu-item name="1" class='logo'>
          <a class="navbar-brand" href="/explore">MMKG in Fashion</a>
        </i-menu-item>
        <i-menu-item name="2">
          <i-button type="primary" class='filter' @click="filter">Filter</i-button>
        </i-menu-item>
        <i-menu-item name="3">
          <i-button type="primary" class='setting filter' @click='setting'>Setting</i-button>
        </i-menu-item>
        <i-menu-item name="4" class='login'>
          <!-- <span class="navbar-text navbar-right">{{username}}</span> -->
          <span class="navbar-text navbar-right">admin</span>
          <a class="nav-link navbar-right" href="/logout">Logout</a>
        </i-menu-item>
      </i-menu>
      <div class='content'>
        <div class='imgs-box'>
          <i-col :lg='24/config.layouts' v-for="(item, index) in items">
            <Poptip trigger="hover" placement="right" class="img-container" v-if='config.mode == "Browse"'>
              <img :width="item.width" :height="item.height" :alt="item.index" :src="item.src">
              <span class='bounding-box face-bounding-box' v-if="config.show_face_bouding" v-for="position in item.face_detction.boxes"
                v-bind:style="{left: position.left,width: position.width,top: position.top,height: position.height}">
              </span>
              <span class='bounding-box body-bounding-box' v-if="config.show_body_bouding" v-for="position in item.object_detction" v-bind:style="{left: position.left,width: position.width,top: position.top,height: position.height}">
              </span>
              <div class="api" slot="content">
                123132
              </div>
            </Poptip>
            <div class="img-container mark-mode" v-if='config.mode == "Mark"'>
              <img :width="item.width" :height="item.height" :alt="item.index" :src="item.src">
              <span class='bounding-box face-bounding-box' v-if="config.show_face_bouding" v-for="position in item.face_detction.boxes"
                v-bind:style="{left: position.left,width: position.width,top: position.top,height: position.height}">
              </span>
              <span class='bounding-box body-bounding-box' v-if="config.show_body_bouding" v-for="position in item.object_detction" v-bind:style="{left: position.left,width: position.width,top: position.top,height: position.height}">
              </span>
              <Row class='lables'>
                <i-col :lg='24/config.task.option.length' v-for="(option, index) in config.task.option">
                  <i-button type="ghost" @click='mark(option,item.id)'>{{option}}</i-button>
                </i-col>
              </Row>
            </div>
          </i-col>
        </div>
      </div>
      <footer>
        <Page :page-size='config.batch' :current="config.page" :total="pages.count" show-elevator show-total @on-change='pageChange'
          @on-page-size-change='pageSizeChange'></Page>
      </footer>
      <Modal v-model="filterModalConfig.show" :mask-closable="filterModalConfig.maskClosable" :loading="filterModalConfig.loading"
        title="Filter Modal" class='filter-modal' @on-ok="filterConfirm">
        <Row>
          <i-col span="12" class='left'>
            <span>Start Time</span>
          </i-col>
          <i-col span="12" class='right'>
            <date-picker type="datetime" placeholder="Select time" @on-change='startTimeChange'></date-picker>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>End Time</span>
          </i-col>
          <i-col span="12" class='right'>
            <date-picker type="datetime" placeholder="Select time" @on-change='endTimeChange'></date-picker>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>Longitude</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.location.longitude[0]' :min="-180" :max="180" class='small'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.location.longitude[1]' :min="-180" :max="180" class='small'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>Latitude</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.location.latitude[0]' :min="-90" :max="90" class='small'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.location.latitude[1]' :min="-90" :max="90" class='small'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>Country</span>
          </i-col>
          <i-col span="12" class='right'>
            <auto-complete @on-search="handleSearch" @on-select='selcetCountry' placeholder="Select value" style="width:200px">
              <i-option v-for="item in searchCountry" :value="item.value" :key="item.name">
                <span>{{item.name}}</span>
                <span class='num-tip'>{{item.num}}</span>
              </i-option>
            </auto-complete>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>Hashtags</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-select v-model="filters.hashtags" style="width:200px" multiple>
              <i-option v-for="item in hashTagList" :value="item.key" :key="item.key">
                <span>{{item.key}}</span>
                <span class='num-tip'>{{item.value}}</span>
              </i-option>
            </i-select>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>Num of Persons</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.persons[0]' :min="0" class='small' :precision='0'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.persons[1]' :min="0" class='small' :precision='0'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>Num of Faces</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.faces[0]' :min="0" class='small' :precision='0'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.faces[1]' :min="0" class='small' :precision='0'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>Num of Likes</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.likes[0]' :min="0" class='small' :precision='0'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.likes[1]' :min="0" class='small' :precision='0'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>Num of Comments</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.comments[0]' :min="0" class='small' :precision='0'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.comments[1]' :min="filters.comments[0] || 0" class='small' :precision='0'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>Posters</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-input placeholder="multi-posters splited by '|'" v-model='filters.bloggers'></i-input>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>dark_degree</span>
          </i-col>
          <i-col span="12" class='right'>
            <input-number v-model='filters.dark_degree' :min="0" :max="1" class='small' :precision='0'></input-number>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>has_url</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-switch v-model="filters.has_url"></i-switch>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>has_watermark</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-switch v-model="filters.has_watermark"></i-switch>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>is_face_in_body</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-switch v-model="filters.is_face_in_body"></i-switch>
          </i-col>
        </Row>
        <Row v-if='filters.is_face_in_body'>
          <i-col span="12" class='left'>
            <span>face_body_per</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.face_body_per[0]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.face_body_per[1]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row v-if='filters.is_face_in_body'>
          <i-col span="12" class='left'>
            <span>face_per</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.face_per[0]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.face_per[1]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row v-if='filters.is_face_in_body'>
          <i-col span="12" class='left'>
            <span>body_per</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.body_per[0]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.body_per[1]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row v-if='filters.is_face_in_body'>
          <i-col span="12" class='left'>
            <span>face_body_w_per</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.face_body_w_per[0]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.face_body_w_per[1]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row v-if='filters.is_face_in_body'>
          <i-col span="12" class='left'>
            <span>face_body_h_per</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.face_body_h_per[0]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.face_body_h_per[1]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row v-if='filters.is_face_in_body'>
          <i-col span="12" class='left'>
            <span>face_w_per</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.face_w_per[0]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.face_w_per[1]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row v-if='filters.is_face_in_body'>
          <i-col span="12" class='left'>
            <span>face_h_per</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.face_h_per[0]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.face_h_per[1]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row v-if='filters.is_face_in_body'>
          <i-col span="12" class='left'>
            <span>body_w_per</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.body_w_per[0]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.body_w_per[1]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
          </i-col>
        </Row>
        <Row v-if='filters.is_face_in_body'>
          <i-col span="12" class='left'>
            <span>body_h_per</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-col span="10">
              <input-number v-model='filters.body_h_per[0]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
            <i-col span="2" class='text'>
              to
            </i-col>
            <i-col span="10">
              <input-number v-model='filters.body_h_per[1]' :min="0" :max='1' :precision='2'></input-number>
            </i-col>
          </i-col>
        </Row>
      </Modal>
      <Modal v-model="settingModalConfig.show" :mask-closable="settingModalConfig.maskClosable" title="Seeting Modal" class='filter-modal'
        @on-ok="settingConfirm" @on-cancel="settingCancel">
        <Row>
          <i-col span="12" class='left'>
            <span>Request Batch</span>
          </i-col>
          <i-col span="12" class='right'>
            <input-number v-model='config.batch' :min="1" :precision='0'></input-number>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>Number of Images Per Line</span>
          </i-col>
          <i-col span="12" class='right'>
            <input-number v-model='config.layouts' :min="2" :max='8' :precision='0' :step='2'></input-number>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>Show the Face BoudingBox</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-switch v-model="config.show_face_bouding"></i-switch>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>Show the Body BoudingBox</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-switch v-model="config.show_body_bouding"></i-switch>
          </i-col>
        </Row>
        <Row>
          <i-col span="12" class='left'>
            <span>Work Mode</span>
          </i-col>
          <i-col span="12" class='right'>
            <radio-group v-model="config.mode">
              <Radio label="Browse">Browse</Radio>
              <Radio label="Mark">Mark</Radio>
            </radio-group>
          </i-col>
        </Row>
        <Row v-if='config.mode==="Mark"'>
          <i-col span="12" class='left'>
            <span>Selcet Task</span>
          </i-col>
          <i-col span="12" class='right'>
            <i-select v-model="config.task" style="width:200px">
              <i-option v-for="item in taskList" :value="item" :key="item.task">
                <span>{{item.task}}</span>
              </i-option>
            </i-select>
          </i-col>
        </Row>
      </Modal>
    </div>
    <script src="../static/js/vue.min.js"></script>
    <script src="../static/js/axios.min.js"></script>
    <script src="../static/js/ivew.min.js"></script>
    <script>
      var app = new Vue({
        el: '#app',
        components: {},
        mounted: function () {
          this.getItems();
          this.getHashTagList();
          this.getCountryList();
          this.getTaskList();
        },
        data: {
          hashTagList: [],
          searchCountry: [],
          countryList: [],
          taskList: [],
          config: {
            layouts: 6,
            batch: 120,
            page: 1,
            show_face_bouding: true,
            show_body_bouding: true,
            mode: "Mark",
            task: ""
          },
          items: [],
          pages: {},
          filterModalConfig: {
            title: 'Filter Modal',
            show: false,
            maskClosable: false,
            loading: true,
          },
          settingModalConfig: {
            title: 'Filter Modal',
            show: false,
            maskClosable: false,
            loading: true,
          },
          filters: {
            time: ['', ''],
            location: {
              name: "",
              longitude: ['', ''],
              latitude: ['', ''],
            },
            hashtags: '',
            persons: ['', ''],
            faces: ['', ''],
            likes: ['', ''],
            comments: ['', ''],
            bloggers: '',
            is_face_in_body: false,
            face_body_per: ["", ""],
            face_per: ["", ""],
            body_per: ["", ""],
            face_body_w_per: ["", ""],
            face_body_h_per: ["", ""],
            face_w_per: ["", ""],
            face_h_per: ["", ""],
            body_w_per: ["", ""],
            body_h_per: ["", ""],
            has_url: false,
            has_watermark: false,
            dark_degree: ""
          }
        },
        methods: {
          getItems: function () {
            /**
             * 把hashTags bloggers 分割成数组  分隔符 |
             */
            let params = Object.assign({}, this.filters)
            this.formatVerticalBar(['bloggers'], params);
            let data = {
              filters: params,
              page: this.config
            }
            console.log(data)
            /**
             * mock/index.json  是本地mock数据  真正测试时需要修改为线上服务器路径
             */
            axios.get('/mock/index.json', data).then((response) => {
              // axios.post('/get_items',data).then((response)=> {
              let data = response.data.data;
              this.items = data;
              this.formatData(this.items)
              this.pages = response.data.pages;
              this.filterModalConfig.show = false;
            })
          },
          getHashTagList: function () {
            axios.get('/mock/get_hashtag_list.json').then((response) => {
              // axios.get('/get_hashtag_list').then((response)=> {
              let data = response.data.data;
              let keys = Object.keys(data);
              keys.forEach((item) => {
                let json = {
                  key: item,
                  value: data[item]
                }
                this.hashTagList.push(json)
              })
            })
          },
          getCountryList: function () {
            axios.get('/mock/get_country_list.json').then((response) => {
              // axios.get('/get_country_list').then((response)=> {
              let data = response.data.data;
              this.countryList = data;
            })
          },
          getTaskList: function () {
            axios.get('/mock/get_task_list.json').then((response) => {
              // axios.get('/get_task_list').then((response)=> {
              let data = response.data.list;
              this.taskList = data;
              this.config.task = data[0]
            })
          },
          formatData: function (data) {
            data.forEach((item, index) => {
              let width = item.width || '640'
              let height = item.height || '640'
              if (item.face_detction) {
                item.face_detction = JSON.parse(item.face_detction)
                item.face_detction.boxes.forEach((box, index) => {
                  /**
                   * box表示身体bouding-box
                   * box[0] 左上角x坐标
                   * box[1] 左上角y坐标
                   * box[2] width
                   * box[3] height
                   */
                  let temp = {
                    left: box[0] / width * 100 + '%',
                    top: box[1] / height * 100 + '%',
                    width: (box[2] - box[0]) / width * 100 + '%',
                    height: (box[3] - box[1]) / height * 100 + '%',
                  }
                  item.face_detction.boxes[index] = temp;
                })
              } else {
                item.face_detction = {
                  boxes: []
                }
              }
              if (item.object_detction) {
                item.object_detction = JSON.parse(item.object_detction)
                let body_det = item.object_detction;
                let temp = [];
                if (body_det.T_F) {
                  body_det.result.forEach((item) => {
                    if (item[0] == 'person') {
                      let box = item[2]
                      /**
                       * box表示身体bouding-box
                       * box[0] 中心点x坐标
                       * box[1] 中心点y坐标
                       * box[2] width
                       * box[3] height
                       */
                      let obj = {
                        left: (box[0] - box[2] / 2) / width * 100 + '%',
                        top: (box[1] - box[3] / 2) / height * 100 + '%',
                        width: Math.abs(box[2]) / width * 100 + '%',
                        height: Math.abs(box[3]) / height * 100 + '%',
                      }
                      temp.push(obj)
                    }
                  })
                }
                data[index].object_detction = temp;
              } else {
                item.object_detction = [];
              }
            })
          },
          filter: function () {
            this.filterModalConfig.show = true;
          },
          setting: function () {
            this.settingModalConfig.show = true;
          },
          filterConfirm: function () {
            this.config.page = 1;
            this.getItems()
          },
          settingConfirm: function () {
            console.log(this.config)
          },
          settingCancel: function () {
            return;
          },
          formatVerticalBar: function (data, target) {
            data.forEach((item, index) => {
              target[item] = target[item].split('|')
              let temp = target[item];
              temp.forEach((item, index) => {
                temp[index] = item.trim()
              })
            })
          },
          pageChange: function (page) {
            /**
             *page 当前选中页数
             */
            this.config.page = page;
            this.getItems();
          },
          pageSizeChange: function (size) {
            /**
             *size 每页显示条数
             */
            this.config.batch = size;
            this.config.page = 1;
            this.getItems();
          },
          startTimeChange: function (data) {
            this.filters.time[0] = data;
          },
          endTimeChange: function (data) {
            this.filters.time[1] = data;
          },
          handleSearch: function (value) {
            this.searchCountry = [];
            let data = this.countryList
            value = value.toLowerCase();
            for (var i in data) {
              let name = data[i].name.toLowerCase()
              if (name.indexOf(value) > -1) {
                let json = {
                  name: data[i].name,
                  value: i,
                  num: data[i].num_of_ret
                }
                this.searchCountry.push(json)
              }
            }
          },
          selcetCountry: function (val) {
            this.filters.location.name = val;
          },
          mark: function (label, id) {
            let param = {
              task: this.config.task.task,
              id: id,
              lable: label,
              annotator: "xujx",
              label_time: new Date().getTime()
            }
            axios.post('/label', param).then((res) => {
              console.log(res)
            })
          }
        }
      })

    </script>

  </body>

</html>
